---
title: "Phylogenetics"
subtitle: "Workshop on ggplot"
author: "`r paste0('<b>Lokesh Mano</b> • ',format(Sys.time(), '%d-%b-%Y'))`"
output:
  bookdown::html_document2:
          toc: true
          toc_float: true
          toc_depth: 4
          number_sections: true
          theme: flatly
          highlight: tango
          df_print: default
          code_folding: "none"
          self_contained: false
          keep_md: false
          encoding: 'UTF-8'
          css: "assets/lab.css"
---

```{r, include=FALSE}
hooks = knitr::knit_hooks$get()
hook_foldable = function(type) {
  force(type)
  function(x, options) {
    res = hooks[[type]](x, options)
    
    if (isFALSE(options[[paste0("fold.", type)]])) return(res)
    
    paste0(
      "<details><summary>", type, "</summary>\n\n",
      res,
      "\n\n</details>"
    )
  }
}
knitr::knit_hooks$set(
  output = hook_foldable("output"),
  plot = hook_foldable("plot")
)
```

```{r,child="assets/header-lab.Rmd"}
```

```{r, echo=FALSE, warning=FALSE, message=FALSE}
library(dplyr)
library(ggplot2)
library(reshape2)
library(tidyverse)
```

For this course, I have used one of my very simple tree from a few different organisms within the Archaea superkingdom. More specifically, it is the concatenated ribosomal protein tree within archaea, with representatives from the different Phyla: Asgard archaea (Thorarchaeota,  Odinarchaeota, Lokiarchaeota and Heimdallarchaeota), TACK, Euryarchaeota and DPANN. The maximum likelihood phylogeny was reconstructed in IQ-TREE with the LG+F+I+G4 model. The alignment was trimmed to 6,732 positions with the BMGE (Block Mapping and Gathering with Entropy) tool.

# ggtree

`ggtree` is an R package that extends ggplot2 for visualizating and annotating phylogenetic trees with their covariates and other associated data. `ggtree` in combination with `treeio` supports several file formats, including: 

* `read.tree` for reading Newick files.
* `read.phylip` for reading Phylip files.
* `read.jplace` for reading Jplace files.
* `read.nhx` for reading NHX files.
* `read.beast` for parsing output of BEAST
* `read.codeml` for parsing output of CODEML (rst and mlc files)
* `read.codeml_mlc` for parsing mlc file (output of CODEML)
* `read.hyphy` for parsing output of HYPHY
* `read.jplace` for parsing jplace file including output from EPA and pplacer
* `read.nhx` for parsing NHX file including output from PHYLODOG and RevBayes
* `read.paml_rst` for parsing rst file (output of BASEML and CODEML)
* `read.r8s` for parsing output of r8s
* `read.raxml` for parsing output of RAxML

## Reading treefile

```{r, warning=FALSE, message=FALSE}
library(ggtree)
library(treeio)

arch_tree <- read.newick("data/arch_newick.txt")
arch_tree
```

Just like with `ggplot2` we created a basic canvas with `ggplot(...)` and added layers with `+geom_???()`, we can do the same here. The `ggtree` package gives us a `geom_tree()` function. Because `ggtree` is built on top of `ggplot2`, you get `ggplot2`’s default gray theme with white lines. You can override this with a theme from the `ggtree` package.

Because you’ll almost always want to add a tree geom and remove the default background and axes, the `ggtree()` function is essentially a shortcut for `ggplot(...) + geom_tree() + theme_tree()`.

```{r, warning=FALSE, message=FALSE}
ggtree(arch_tree)
#Same as:
#ggplot(arch_tree) + geom_tree() + theme_tree()
```

One can also customize how the tree looks like, just as in `ggplot`

```{r, warning=FALSE, message=FALSE}
ggtree(arch_tree, branch.length="none", color="blue", size=2, linetype=3)
```

You can also use different orientations to show the tree.

```{r, warning=FALSE, message=FALSE}
ggtree(arch_tree, color="blue", layout = "circular")
```

## Geoms and annotation

Just like in `ggplot()` you can add layers to the tree as `geoms`.

```{r, warning=FALSE, message=FALSE}
p <- ggtree(arch_tree)
p + geom_nodepoint() + geom_tiplab(color = "blue") + theme_tree2()
```

Before we can go further into annotating the tree, we need to understand how ggtree is handling the tree structure internally. Some of the functions in ggtree for annotating clades need a parameter specifying the internal node number. To get the internal node number, user can use `geom_text` to display it, where the label is an aesthetic mapping to the “node variable” stored inside the tree object (think of this like the continent variable inside the gapminder object). 

```{r, warning=FALSE, message=FALSE}
p + geom_text(aes(label=node), hjust=-.3)
```

Another way to get the internal node number is using the function `MRCA()` which stands for Most Recent Common Ancestor. From the tree above, if you would like to get the number of the particular node that is common to all the "Lokiarchaea". You can do so like below:

```{r}
MRCA(arch_tree, .node1 = "Baja_Loki3", .node2 =  "Loki_CR4")
```

Now, let us see how we can use this information to make it scientifically intuitive.

```{r}
p + 
  geom_cladelabel(node=46, label="Lokiarchaeota", color="green")
```

ALternatively, we can also highlight an entire clade:

```{r}
p + 
  geom_hilight(node=39, fill = "purple") +
  geom_cladelabel(node=39, label="Thorarchaeota", color="purple")
```





# Session info

```{r, fold.output=FALSE, fold.plot=FALSE}
sessionInfo()
```

__End of document__